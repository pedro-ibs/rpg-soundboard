<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>Mesa de Efeitos Sonoros</title>

		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
		
		<link rel="stylesheet" href="elements/style/style.css">
	</head>

	<body class="container">
		
		<div id="id-body">
			<div id="id-header">
				<section class="header text-center rounded border-0 mt-5">
					<h1>Mesa de Efeitos Sonoros e Ambientação para RPG</h1>
		
					<p class="lead">Toque múltiplas músicas ao mesmo tempo para criar atmosferas únicas</p>
		
					<div class="btn-group" role="group" aria-label="Button group with nested dropdown">
						<button class="btn btn-primary" id="id-add-sond-button" data-bs-toggle="modal" data-bs-target="#id-ModelCard-sound-create">
							<i class="bi bi-plus-circle"></i> Adicionar Novo Som ou Música
						</button>
		
						<div class="btn-group" role="group">
							
							<button id="btnGroupDrop1" type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
								Mais Ações
							</button>
		
							<ul class="dropdown-menu" aria-labelledby="btnGroupDrop1">					
								<li>
									<button class="dropdown-item" id="menu-import-config">
										<i class="bi bi-upload"></i> Importar Configurações
									</button>
								</li>
								
								<li>
									<button class="dropdown-item" id="menu-export-config">
										<i class="bi bi-download"></i> Exportar Configurações
									</button>
								</li>
		
							</ul>
						</div>
					</div>
				</section>

				<section class="currently-playing mt-4" >
					<h4><i class="bi bi-music-note-beamed"></i> Faixas Tocando:</h4>
			
					<div id="current-tracks" class="playing-tracks">
						<p class="mb-0 text-muted">Nenhuma faixa tocando</p>
					</div>
					
					<div class="btn-group control-buttons mt-2" role="group">
						<button class="btn btn-sm btn-success" id="id-sound-event-play-all">
							<i class="bi bi-play"></i> Continuar Todas
						</button>
		
						<button class="btn btn-sm btn-info" id="id-sound-event-pause-all">
							<i class="bi bi-pause"></i> Pausar Todas
						</button>
						
						
						<button class="btn btn-sm btn-danger" id="id-sound-event-stop-all">
							<i class="bi bi-stop"></i> Parar Todas
						</button>
					</div>
				</section>
			</div>

			<section class="category  mb-5 mt-5 pt-5" id="id-content">

				<div id="id-content-category-soundtrack" class="mb-5">
					<div class="category border-bottom d-flex justify-content-between">
						<h3 class="category-title m-2" >Trilha Sonora</h3>
						<div class="d-flex align-self-start m-2">
							<i class="bi bi-volume-up-fill m-2"></i>
							<input type="range" class="volume-control m-2" min="0" max="1" step="0.01" value="1.00" id="id-category-event-volume-soundtrack">
						</div>
					</div>
					<div class="row d-flex flex-md-row flex-sm-column justify-content-center align-items-center mt-3" id="id-content-category-soundtrack-cards">
						<!-- onde os cards devem ser rinderizados -->
					</div>
				</div>

				<div id="id-content-category-background" class="mb-5">
					<div class="category border-bottom d-flex justify-content-between">
						<h3 class="category-title m-2" >Sons Ambiente</h3>
						<div class="d-flex align-self-start  m-2">
							<i class="bi bi-volume-up-fill m-2"></i>
							<input type="range" class="volume-control m-2" min="0" max="1" step="0.01" value="1.00" id="id-category-event-volume-background">
						</div>
					</div>
					<div class="row d-flex flex-md-row flex-sm-column justify-content-center align-items-center mt-3" id="id-content-category-background-cards">
						<!-- onde os cards devem ser rinderizados -->
					</div>
				</div>

				<div id="id-content-category-effects" class="mb-5">
					<div class="category border-bottom d-flex justify-content-between">
						<h3 class="category-title m-2" >Efeitos Sonoros</h3>
						<div class="d-flex align-self-start m-2">
							<i class="bi bi-volume-up-fill m-2"></i>
							<input type="range" class="volume-control m-2" min="0" max="1" step="0.01" value="1.00" id="id-category-event-volume-effects">
						</div>
					</div>
					<div class="row d-flex flex-md-row flex-sm-column justify-content-center align-items-center mt-3" id="id-content-category-effects-cards">
						<!-- onde os cards devem ser rinderizados -->
					</div>
				</div>

			</section>

			

		</div>

		<div id="id-hidden">
			<section id="id-ModelCard">
			</section >


			<section id="id-script">
				<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
				
				<script src="elements/script/config.js"></script>
				<script src="elements/script/actions.js"></script>
				<script src="elements/script/form.js"></script>
				<script src="elements/script/alerts.js"></script>

				<script>
					document.addEventListener('DOMContentLoaded', function() {

						renderModelCard( 'id-ModelCard', 'id-ModelCard-config',			'Carregar Arquivo Configurações',	getHtmlOfLoadConfigForm()	);
						renderModelCard( 'id-ModelCard', 'id-ModelCard-sound-create',		'Adicionar Nova Som ou Musica', 	getHtmlOfSoundForm('create')	);
						renderModelCard( 'id-ModelCard', 'id-ModelCard-sound-update',		'Adicionar Nova Som ou Musica', 	getHtmlOfSoundForm('update')	);

						

						let config = validateConfigurationFile( null );

						const configForm 		= formListener( 'id-ModelCard-config-form',		callbackConfigForm		);
						const SounCreateForm		= formListener( 'id-ModelCard-sound-create-form',	callbackSoundCreateForm		);
						const SounUpdateForm 		= formListener(	'id-ModelCard-sound-update-form',	callbackSoundUpdateForm		)

						document.getElementById('menu-import-config').addEventListener('click', function() { showModelCard( 'id-ModelCard-config'			) });
						document.getElementById('menu-export-config').addEventListener('click', function() { exportConfiguration( 'rpg-soundboard-config', config	) });

						formVal();

						function callbackConfigForm(){

							const fileInput = document.getElementById('id-ModelCard-config-form-file');
							
							if (fileInput.files.length === 0) {
								showErrorAlert("Por favor, selecione um arquivo JSON!")
								return;
							}
							
							const file = fileInput.files[0];


							if (file.type !== 'application/json' && !file.name.toLowerCase().endsWith('.json')) {
								showErrorAlert("Por favor, selecione um arquivo JSON válido!")
								return;
							}

							const reader = new FileReader();
							
							reader.onload = function(event) {
								try {
									let jsonData = JSON.parse(event.target.result);
								
									
									jsonData = validateConfigurationFile(jsonData);

									config = jsonData;

									hideModelCard('id-ModelCard-config');
									
									console.log('JSON carregado com sucesso:', config);
									showSuccessAlert( "Configuração carregada com sucesso!" );

									renderCard('id-content-category-soundtrack-cards',	 filterSoundByCategory(config.sounds, 'soundtrack'	) );
									renderCard('id-content-category-background-cards',	 filterSoundByCategory(config.sounds, 'background'	) );
									renderCard('id-content-category-effects-cards',		 filterSoundByCategory(config.sounds, 'effects'		) );
									
								} catch (error) {

									console.error('Erro ao fazer parse do JSON:', error);

									jsonData = validateConfigurationFile( null );

									config = jsonData;
									
									hideModelCard('id-ModelCard-config');
									
									console.log('configuração padrão carregada:', config);
									showWarningAlert("Erro de formato de arquivo, configuração padrão carregada!", 5000)

								}
							};
							
							reader.onerror = function() {
								showErrorAlert("Erro ao ler o arquivo de configuração por favor carregue o arquivo novamente", 5000)

							};
							
							reader.readAsText(file);


						}

						function callbackSoundCreateForm() {
							let title		= document.getElementById('id-ModelCard-sound-create-form-title'		);
							let file		= document.getElementById('id-ModelCard-sound-create-form-file'			);
							let category		= document.getElementById('id-ModelCard-sound-create-form-category-options'	);
							let volume		= document.getElementById('id-ModelCard-sound-create-form-volume'		);
							let loop		= document.getElementById('id-ModelCard-sound-create-form-loop'			);

							title 		= title.value.trim();
							category 	= category.value.trim();
							file 		= file.value.split('\\').at(-1).trim(),
							volume	 	= volume.value;
							loop 		= loop.checked;

							sound = {
								id:		config.id_counter + 1,
								title:		title,
								sound:		file,
								category:	category,
								volume:		volume,
								loop:		loop
							};

							config.id_counter = sound.id;

							config.sounds.splice(config.sounds.length + 1, 0, sound );
							console.log('Som Carregado com sucesso:', config);
							

							showSuccessAlert( `Som "${sound.title}" criado com sucesso!` );

							hideModelCard( 'id-ModelCard-sound-create' );

							document.getElementById('id-ModelCard-sound-create-form').reset();

						}

						function callbackSoundUpdateForm(){

							let title		= document.getElementById('id-ModelCard-sound-update-form-title'		);
							let file		= document.getElementById('id-ModelCard-sound-update-form-file'			);
							let category		= document.getElementById('id-ModelCard-sound-update-form-category-options'	);
							let volume		= document.getElementById('id-ModelCard-sound-update-form-volume'		);
							let loop		= document.getElementById('id-ModelCard-sound-update-form-loop'			);
							let sound_id		= document.getElementById('id-ModelCard-sound-update-form-element'		);

							title 			= title.value.trim();
							category 		= category.value.trim();
							file 			= file.value.split('\\').at(-1).trim(),
							volume	 		= volume.value;
							loop 			= loop.checked;
							sound_id		= sound_id.innerHTML;

							sound = {
								id:		sound_id,
								title:		title,
								sound:		file,
								category:	category,
								volume:		volume,
								loop:		loop
							};

							config.sounds = removeSoundById(config.sounds, sound_id);

							document.getElementById(`id-sound-content-${sound.id}` ).innerHTML = buildCardBody(sound);
							

							showSuccessAlert( `Som "${sound.title}" atualizado com sucesso!` );

							hideModelCard( 'id-ModelCard-sound-update' );

							document.getElementById('id-ModelCard-sound-update-form').reset();	
						}


						function editeCard( target_id ){

							const sound_id = target_id.split('-').at(-1);
							console.log(sound_id);

							sound = filterSoundById(config.sounds, sound_id);

							document.getElementById('id-ModelCard-sound-update-form-title'			).value 	= sound.title
							document.getElementById('id-ModelCard-sound-update-form-file'			).textContent 	= sound.file;
							document.getElementById('id-ModelCard-sound-update-form-category-options'	).value 	= sound.category;
							document.getElementById('id-ModelCard-sound-update-form-volume'			).value 	= sound.volume;
							document.getElementById('id-ModelCard-sound-update-form-loop'			).checked	= sound.loop;
							document.getElementById('id-ModelCard-sound-update-form-element' 		).innerHTML	= sound.id;


							showModelCard( 'id-ModelCard-sound-update' );

						}

						function removeCard( target_id ){

							const sound_id = target_id.split('-').at(-1);

							const div = document.getElementById( `id-sound-content-${sound_id}` );
							div.remove();

							config.sounds = removeSoundById(config.sounds, sound_id)

							console.log('configuração alterada:', config);

							showSuccessAlert( "Faixa removida!" );
						}

						showModelCard( 'id-ModelCard-config' );

						document.body.addEventListener('click', function(event) {
							if (event.target.tagName === 'BUTTON') {
								handleEvent(event.target.id, 'id-sound-event-edit',	editeCard	);
								handleEvent(event.target.id, 'id-sound-event-remove',	removeCard	);
							}
						});


						document.body.addEventListener('input', function(event) {
							if (event.target.type === 'range') {
								console.log('Range alterado:', event.target.id, 'Valor:', event.target.value);
							}

							if (event.target.type === 'checkbox') {
								console.log('Opção alterado:', event.target.id, 'Valor:', event.target.value);
							}
						});

					});
				</script>
			</section>
		</div>
	</body>
</html>