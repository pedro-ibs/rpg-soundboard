<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>Mesa de Efeitos Sonoros</title>

		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
		
		<link rel="stylesheet" href="elements/style/style.css">
	</head>

	<body class="container">
		
		<div id="id-body">
			<div id="id-header">
				<section class="header text-center rounded border-0 mt-5">
					<h1>Mesa de Efeitos Sonoros e Ambientação para RPG</h1>
		
					<p class="lead">Toque múltiplas músicas ao mesmo tempo para criar atmosferas únicas</p>
		
					<div class="btn-group" role="group" aria-label="Button group with nested dropdown">
						<button class="btn btn-primary" id="id-add-sond-button" data-bs-toggle="modal" data-bs-target="#id-ModelCard-sound-create">
							<i class="bi bi-plus-circle"></i> Adicionar Novo Som ou Música
						</button>
		
						<div class="btn-group" role="group">
							
							<button id="btnGroupDrop1" type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
								Mais Ações
							</button>
		
							<ul class="dropdown-menu" aria-labelledby="btnGroupDrop1">					
								<li>
									<button class="dropdown-item" id="menu-import-config">
										<i class="bi bi-upload"></i> Importar Configurações
									</button>
								</li>
								
								<li>
									<button class="dropdown-item" id="menu-export-config">
										<i class="bi bi-download"></i> Exportar Configurações
									</button>
								</li>
		
							</ul>
						</div>
					</div>

					<div class="alert alert-info mt-3 mb-0">
						<small>
						<i class="bi bi-info-circle"></i> 
							<strong>Importante:</strong> Coloque seus arquivos de áudio na pasta <code>sounds/</code> na raiz do projeto para que sejam carregados corretamente. 
						</small>
					</div>

				</section>

				<section class="currently-playing mt-4" >
					<h4><i class="bi bi-music-note-beamed"></i> Faixas Tocando:</h4>
			
					<div id="current-tracks" class="playing-tracks">
						<p class="mb-0">Nenhuma faixa tocando</p>

					</div>
					
					<div class="btn-group control-buttons mt-2" role="group">
						<button class="btn btn-sm btn-success" id="id-sound-event-play-all">
							<i class="bi bi-play"></i> Continuar Todas
						</button>
		
						<button class="btn btn-sm btn-info" id="id-sound-event-pause-all">
							<i class="bi bi-pause"></i> Pausar Todas
						</button>
						
						
						<button class="btn btn-sm btn-danger" id="id-sound-event-stop-all">
							<i class="bi bi-stop"></i> Parar Todas
						</button>
					</div>
				</section>
			</div>

			<section class="category  mb-5 mt-5 pt-5" id="id-content">

				<div id="id-content-category-soundtrack" class="mb-5">
					<div class="category border-bottom d-flex justify-content-between">
						<h3 class="category-title m-2" >Trilha Sonora</h3>
						<div class="d-flex align-self-start m-2">
							<i class="bi bi-volume-up-fill m-2"></i>
							<input type="range" class="volume-control m-2" min="0" max="1" step="0.01" value="1.00" id="id-category-event-volume-soundtrack">
						</div>
					</div>
					<div class="row d-flex flex-md-row flex-sm-column justify-content-center align-items-center mt-3" id="id-content-category-soundtrack-cards">
						<!-- onde os cards devem ser rinderizados -->
					</div>
				</div>

				<div id="id-content-category-background" class="mb-5">
					<div class="category border-bottom d-flex justify-content-between">
						<h3 class="category-title m-2" >Sons Ambiente</h3>
						<div class="d-flex align-self-start  m-2">
							<i class="bi bi-volume-up-fill m-2"></i>
							<input type="range" class="volume-control m-2" min="0" max="1" step="0.01" value="1.00" id="id-category-event-volume-background">
						</div>
					</div>
					<div class="row d-flex flex-md-row flex-sm-column justify-content-center align-items-center mt-3" id="id-content-category-background-cards">
						<!-- onde os cards devem ser rinderizados -->
					</div>
				</div>

				<div id="id-content-category-effects" class="mb-5">
					<div class="category border-bottom d-flex justify-content-between">
						<h3 class="category-title m-2" >Efeitos Sonoros</h3>
						<div class="d-flex align-self-start m-2">
							<i class="bi bi-volume-up-fill m-2"></i>
							<input type="range" class="volume-control m-2" min="0" max="1" step="0.01" value="1.00" id="id-category-event-volume-effects">
						</div>
					</div>
					<div class="row d-flex flex-md-row flex-sm-column justify-content-center align-items-center mt-3" id="id-content-category-effects-cards">
						<!-- onde os cards devem ser rinderizados -->
					</div>
				</div>

			</section>

			

		</div>

		<div id="id-hidden">
			<section id="id-ModelCard">
			</section >


			<section id="id-script">
				<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
				
				<script src="elements/script/alerts.js"></script>

				<script src="elements/script/config.js"></script>
				<script src="elements/script/audio-system.js"></script>
				<script src="elements/script/actions.js"></script>
				<script src="elements/script/form.js"></script>
				

				<script>
					document.addEventListener('DOMContentLoaded', function() {

						let appState = {
							playingSounds: new Map(),
							
							config: validateConfigurationFile( null ),

							categoryVolumes: {
								soundtrack: 1.0,
								background: 1.0,
								effects: 1.0
							}
						};

						

						function refreshAllCards() {
							renderCard('id-content-category-soundtrack-cards',	filterSoundByCategory( appState.config.sounds, 'soundtrack'	), appState );
							renderCard('id-content-category-background-cards',	filterSoundByCategory( appState.config.sounds, 'background'	), appState );
							renderCard('id-content-category-effects-cards', 	filterSoundByCategory( appState.config.sounds, 'effects'	), appState );

							updateCurrentlyPlaying()
						}

						function updateCurrentlyPlaying() {
							const container = document.getElementById('current-tracks');
							const playingSounds = Array.from(appState.playingSounds.entries()).filter(([_, state]) => state === 'playing' || state === 'paused');
								
							if (playingSounds.length === 0) {
								container.innerHTML = '<p class="mb-0 text-muted">Nenhuma faixa tocando</p>';
								return;
							}
						
							let html = '';
							playingSounds.forEach(([soundId, state]) => {
								const sound = filterSoundById(appState.config.sounds, soundId);
								if (sound) {
									// html += `<div class="track-item">
									// 	<span>${sound.title}</span>
									// 	<div class="track-controls">
									// 		<span class="badge ${state === 'playing' ? 'bg-success' : 'bg-warning'}">
									// 			${state === 'playing' ? '<i class="bi bi-play"></i>' : '<i class="bi bi-pause"></i>'}
									// 		</span>
									// 	</div>
									// </div>`;


									// html += `<div class="track-item">
									// 	<span>${sound.title}</span>
									// 	<div class="track-controls">
									// 		<span class="badge ${state === 'playing' ? 'bg-success' : 'bg-info'}">
									// 			${state === 'playing' ? '<i class="bi bi-play"></i>' : '<i class="bi bi-pause"></i>'}
									// 		</span>
									// 	</div>
									// </div>`


									html += `<div class="track-item">
										<span>${sound.title}</span>
										<div class="track-controls">
											<div class="control-buttons btn-group mb-2">
												<button class="btn btn-sm btn-success resume-btn" id="id-sound-event-play-${sound.id}"}>
													<i class="bi bi-play"></i> 
												</button>
												<button class="btn btn-sm btn-info pause-btn" id="id-sound-event-pause-${sound.id}"}>
													<i class="bi bi-pause"></i> 
												</button>
												<button class="btn btn-sm btn-danger stop-btn" id="id-sound-event-stop-${sound.id}">
													<i class="bi bi-stop"></i> 
												</button>
											</div>
										</div>
									</div>`


									// html += `<div class="track-item d-flex align-items-center justify-content-between">
									// 		<div class="fw-bold">${sound.title}</div>
									// 		<progress class="form-range mx-3" id="id-track-progress-${soundId}" value="0" max="100" style="width: 70%; height: 6px;"></progress>
									// 	<div class="track-controls d-flex align-items-center">
									// 		<span class="badge ${state === 'playing' ? 'bg-success' : 'bg-info'}">
									// 			${state === 'playing' ? '<i class="bi bi-play"></i>' : '<i class="bi bi-pause"></i>'}
									// 		</span>
									// 	</div>
									// </div>`;
								}
							});

							container.innerHTML = html;
						}


						let audioSystem = createAudioSystem(appState, refreshAllCards, updateCurrentlyPlaying);


						function callbackConfigForm(){

							const fileInput = document.getElementById('id-ModelCard-config-form-file');
							
							if (fileInput.files.length === 0) {
								showErrorAlert("Por favor, selecione um arquivo JSON!")
								return;
							}
							
							const file = fileInput.files[0];


							if (file.type !== 'application/json' && !file.name.toLowerCase().endsWith('.json')) {
								showErrorAlert("Por favor, selecione um arquivo JSON válido!")
								return;
							}

							const reader = new FileReader();
							
							reader.onload = function(event) {
								try {
									let jsonData = JSON.parse(event.target.result);
								
									
									jsonData = validateConfigurationFile(jsonData);

									appState.config = jsonData;

									refreshAllCards();

									hideModelCard('id-ModelCard-config');
									
									console.log('JSON carregado com sucesso:', appState.config);
									showSuccessAlert( "Configuração carregada com sucesso!" );


									
								} catch (error) {

									console.error('Erro ao fazer parse do JSON:', error);

									jsonData = validateConfigurationFile( null );

									appState.config = jsonData;
									
									hideModelCard('id-ModelCard-config');
									
									console.log('configuração padrão carregada:', appState.config);
									showWarningAlert("Erro de formato de arquivo, configuração padrão carregada!", 5000)

								}
							};
							
							reader.onerror = function() {
								showErrorAlert("Erro ao ler o arquivo de configuração por favor carregue o arquivo novamente", 5000)

							};
							
							reader.readAsText(file);


						}

						function callbackSoundCreateForm() {
							let title		= document.getElementById('id-ModelCard-sound-create-form-title'		);
							let file		= document.getElementById('id-ModelCard-sound-create-form-file'			);
							let category		= document.getElementById('id-ModelCard-sound-create-form-category-options'	);
							let volume		= document.getElementById('id-ModelCard-sound-create-form-volume'		);
							let loop		= document.getElementById('id-ModelCard-sound-create-form-loop'			);

							title 		= title.value.trim();
							category 	= category.value.trim();
							file 		= file.value.split('\\').at(-1).trim(),
							volume	 	= volume.value;
							loop 		= loop.checked;

							sound = {
								id:		appState.config.id_counter + 1,
								title:		title,
								sound:		file,
								category:	category,
								volume:		volume,
								loop:		loop
							};

							appState.config.id_counter = sound.id;

							appState.config.sounds.splice(appState.config.sounds.length + 1, 0, sound );
							console.log('Som Carregado com sucesso:', appState.config);
							
							refreshAllCards();

							showSuccessAlert( `Som "${sound.title}" criado com sucesso!` );

							hideModelCard( 'id-ModelCard-sound-create' );

							document.getElementById('id-ModelCard-sound-create-form').reset();



						}

						function callbackSoundUpdateForm(){

							let title		= document.getElementById('id-ModelCard-sound-update-form-title'		);
							let category		= document.getElementById('id-ModelCard-sound-update-form-category-options'	);
							let volume		= document.getElementById('id-ModelCard-sound-update-form-volume'		);
							let loop		= document.getElementById('id-ModelCard-sound-update-form-loop'			);
							let sound_id		= document.getElementById('id-ModelCard-sound-update-form-element'		);

							title 			= title.value.trim();
							category 		= category.value.trim();
							volume	 		= volume.value;
							loop 			= loop.checked;
							sound_id		= sound_id.innerHTML;

							sound = filterSoundById(appState.config.sounds, sound_id);

							sound.title	= title,
							sound.category	= category,
							sound.volume	= volume,
							sound.loop	= loop


							updateSoundById(appState.config.sounds, sound_id, sound);

							sound_id.innerHTML = '';

							showSuccessAlert( `Som "${sound.title}" atualizado com sucesso!` );

							refreshAllCards();

							hideModelCard( 'id-ModelCard-sound-update' );

							document.getElementById('id-ModelCard-sound-update-form').reset();	
						}

						function editeCard( target_id ){

							const sound_id = target_id.split('-').at(-1);
							console.log(sound_id);

							sound = filterSoundById(appState.config.sounds, sound_id);

							document.getElementById('id-ModelCard-sound-update-form-title'			).value 	= sound.title
							document.getElementById('id-ModelCard-sound-update-form-category-options'	).value 	= sound.category;
							document.getElementById('id-ModelCard-sound-update-form-volume'			).value 	= sound.volume;
							document.getElementById('id-ModelCard-sound-update-form-loop'			).checked	= sound.loop;
							document.getElementById('id-ModelCard-sound-update-form-element' 		).innerHTML	= sound.id;


							showModelCard( 'id-ModelCard-sound-update' );

						}

						function removeCard( target_id ){

							const sound_id = target_id.split('-').at(-1);

							audioSystem.stop(sound_id);

							const div = document.getElementById( `id-sound-content-${sound_id}` );
							div.remove();

							appState.config.sounds = removeSoundById(appState.config.sounds, sound_id)

							console.log('configuração alterada:', appState.config);

							showSuccessAlert( "Faixa removida!" );
						}

						function updateSoundVolume( event ){
							const soundId = event.target.id.split('-').at(-1);
							const volume = parseFloat(event.target.value);
							
							// Atualiza o volume no estado
							const sound = filterSoundById(appState.config.sounds, soundId);
							if (sound) {
								sound.volume = volume;
								audioSystem.setVolume(soundId, volume);
							}
						}
						
						function updateSoundLoop( event ){
							const soundId = event.target.id.split('-').at(-1);
							const loop = event.target.checked;
							
							const sound = filterSoundById(appState.config.sounds, soundId);
							if (sound) {
								sound.loop = loop;
							
								// Atualiza a instância de áudio se existir
								const audio = audioSystem.instances.get(soundId);
								if (audio) {
									audio.loop = loop;
								}
							}
						}


						renderModelCard( 'id-ModelCard', 'id-ModelCard-config',			'Carregar Arquivo Configurações',	getHtmlOfLoadConfigForm()	);
						renderModelCard( 'id-ModelCard', 'id-ModelCard-sound-create',		'Adicionar Nova Som ou Musica', 	getHtmlOfSoundForm('create')	);
						renderModelCard( 'id-ModelCard', 'id-ModelCard-sound-update',		'Adicionar Nova Som ou Musica', 	getHtmlOfSoundForm('update')	);

						formListener( 'id-ModelCard-config-form',	callbackConfigForm		);
						formListener( 'id-ModelCard-sound-create-form',	callbackSoundCreateForm		);
						formListener( 'id-ModelCard-sound-update-form',	callbackSoundUpdateForm		);

						formVal();

						showModelCard( 'id-ModelCard-config' );

						document.getElementById('menu-import-config').addEventListener('click', function() { showModelCard( 'id-ModelCard-config'					) });
						document.getElementById('menu-export-config').addEventListener('click', function() { exportConfiguration( 'rpg-soundboard-config', appState.config		) });
						document.getElementById( `id-ModelCard-sound-update-form-file` ).remove();

						document.getElementById('id-sound-event-play-all').addEventListener('click', () => audioSystem.playAll());
						document.getElementById('id-sound-event-pause-all').addEventListener('click', () => audioSystem.pauseAll());
						document.getElementById('id-sound-event-stop-all').addEventListener('click', () => audioSystem.stopAll());


						document.getElementById('id-category-event-volume-soundtrack').addEventListener('input', (e) => {
							audioSystem.updateCategoryVolume('soundtrack', parseFloat(e.target.value));
						});

						document.getElementById('id-category-event-volume-background').addEventListener('input', (e) => {
							audioSystem.updateCategoryVolume('background', parseFloat(e.target.value));
						});

						document.getElementById('id-category-event-volume-effects').addEventListener('input', (e) => {
							audioSystem.updateCategoryVolume('effects', parseFloat(e.target.value));
						});



						document.body.addEventListener('click', function(event) {

							// console.log('Click detectado no elemento:', event.target);
							console.log('ID do elemento:', event.target.id);
							console.log('Tag do elemento:', event.target.tagName);


							// Encontra o elemento botão (pode ser o próprio ou um pai)
							let buttonElement = event.target;
							
							// Se o clique foi em um elemento dentro do botão, sobe até encontrar o botão
							while (buttonElement && buttonElement.tagName !== 'BUTTON') {
								buttonElement = buttonElement.parentElement;
								if (!buttonElement) break;
							}

							
							if (buttonElement && buttonElement.tagName === 'BUTTON') {

								handleEvent(buttonElement.id, 'id-sound-event-edit',	editeCard	);
								handleEvent(buttonElement.id, 'id-sound-event-remove',	removeCard	);

								handleEvent(buttonElement.id, 'id-sound-event-play', (targetId) => {
									const soundId = targetId.split('-').at(-1);
									audioSystem.play(soundId);
								});
									
								handleEvent(buttonElement.id, 'id-sound-event-pause', (targetId) => {
									const soundId = targetId.split('-').at(-1);
									audioSystem.pause(soundId);
								});
									
								handleEvent(buttonElement.id, 'id-sound-event-stop', (targetId) => {
									const soundId = targetId.split('-').at(-1);
									audioSystem.stop(soundId);
								});

							}
						});


						document.body.addEventListener('input', function(event) {

							if (event.target.classList.contains('volume-control') &&  event.target.id.startsWith('id-sound-event-volume-')) {
								updateSoundVolume( event );
							}
							
							if (event.target.classList.contains('loop-checkbox') &&  event.target.id.startsWith('id-sound-event-loop-')) {
								updateSoundLoop( event )
							}
						});

					});
				</script>
			</section>
		</div>
	</body>
</html>